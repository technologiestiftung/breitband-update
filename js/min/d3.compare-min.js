function d3_compare(){function e(i){t=i,d3.csv("data/all.csv").get(function(t,i){i.forEach(function(e){e.jahr*=1,e.leitung50*=1,e.leitung16*=1}),n=["leitung16","leitung50"].map(function(e){return i.map(function(t){return{type:e,value:t[e],ortsteil:t.ortsteil,bezirk:t.bezirk,jahr:t.jahr,data:t}})}).reduce(function(e,t){return e.concat(t)},[]),l=d3.nest().key(function(e){return e.type}).key(function(e){return e.bezirk}).key(function(e){return e.jahr}).rollup(function(e){var t=d3.mean(e,function(e){return e.value});return e.forEach(function(e){e.mean=t}),t}).entries(n),l.forEach(function(e,t,n){e.values.forEach(function(t,n,r){w[e.key][t.key]=t.values[2].values})}),a=d3.nest().key(function(e){return e.type}).key(function(e){return e.bezirk}).key(function(e){return e.ortsteil}).entries(n),r=d3.nest().key(function(e){return e.bezirk}).entries(n),r.forEach(function(e){e.mean=d3.mean(e.values.filter(function(e){return 2017===e.jahr&&"leitung16"===e.type}),function(e){return e.value}).toFixed(1)+"% | "+d3.mean(e.values.filter(function(e){return 2017===e.jahr&&"leitung50"===e.type}),function(e){return e.value}).toFixed(1)+"%"}),r.sort(function(e,t){return t.mean-e.mean}),e.init()})}var t,n,r,a,l,i,o,c,s,u,d,f,p,v,h,k,m,g,y,b={activeMenu:!1,item:null},z={leitung16:"> 16Mbit",leitung50:"> 50Mbit"},A=[0,25,50,70,85,95,100],x={top:20,right:45,bottom:20,left:45},w={leitung16:{},leitung50:{}},M={Wilmersdorf:"Charlottenburg-Wilmersdorf",Kreuzberg:"Friedrichshain-Kreuzberg",Wartenberg:"Lichtenberg",Hellersdorf:"Marzahn-Hellersdorf",Rudow:"Neukölln",Wilhelmsruh:"Pankow",Hansaviertel:"Mitte",Wittenau:"Reinickendorf",Wilhelmsstadt:"Spandau",Tempelhof:"Tempelhof-Schöneberg",Zehlendorf:"Steglitz-Zehlendorf","Schmöckwitz":"Treptow-Köpenick"};return e.resize=function(){g.selectAll("*").remove();var t=d3.select("#compare .chart .col"),n=t.node().getBoundingClientRect();i=n.width-x.right-x.left,o=n.height-x.top-x.bottom,c=d3.scale.linear().range([0,i]).domain([2011,2017]),u=o/(A.length-1),d=[6*u,5*u,4*u,3*u,2*u,u,0],s=d3.scale.linear().range(d).domain(A),f=d3.svg.axis().scale(c).orient("bottom").tickValues([2011,2012,2013,2015,2017]).tickFormat(d3.format("")),p=d3.svg.axis().tickFormat(function(e){return e>0?e+"%":void 0}).scale(s).orient("left").tickSize(-i),v=d3.svg.line().x(function(e){return c(e.jahr)}).y(function(e){return s(e.mean)}),h=d3.svg.line().x(function(e){return c(e.jahr)}).y(function(e){return s(e.value)}),g.call(e.makeAxis),[g.selectAll(".bezirke").data(function(e){return e.values}).enter().append("g").attr("class","real").attr("data-key",function(e){return d3.select(this.parentNode).data()[0].key}).classed("bezirke",!0),g.selectAll(".bezirke.alpha").data(function(e){return e.values}).enter().append("g").attr("class","alpha").attr("data-key",function(e){return d3.select(this.parentNode).data()[0].key}).classed("bezirke",!0)].forEach(function(e,t,n){e.selectAll(".ortsteil").data(function(e){return e.values}).enter().append("path").attr("id",function(e){return"ortsteil_"+e.key}).attr("class",function(e){return M[e.key]in w.leitung50?"overbezirk":"normalbezirk"}).classed("ortsteil",!0).attr("d",function(e){return v(e.values)}).on("mouseenter",function(e){var t=d3.select(this.parentNode).datum(),n=d3.select(this.parentNode).attr("data-key"),r=d3.select("#"+n).node().getBoundingClientRect(),a={top:r.top+window.scrollY,left:r.left+window.scrollX},l=a.left+c(e.values[3].jahr)+x.left,i;i=b.activeMenu?a.top+s(e.values[3].value)+x.top+3:a.top+s(e.values[3].mean)+x.top+3,k.selectAll(".entry").classed("hover",function(e){return e.key===t.key&&!b.activeMenu}),m.classed("hover",!0).selectAll(".bezirke").classed("active",function(e){return t.key===e.key}).filter(".active").moveToFront(),m.selectAll(".bezirke").selectAll(".ortsteil").classed("hover",function(t){return e.key===t.key}).filter(".hover").moveToFront();var o=b.activeMenu?e.key:t.key;tooltip.content('<strong class="center">'+o+"</strong>"),tooltip.position([l,i]),tooltip.show()}).on("mouseleave",function(e){k.selectAll(".entry").classed("hover",!1),m.classed("hover",!1).selectAll(".bezirke").classed("hover",!1).selectAll(".ortsteil").classed("hover",!1),tooltip.hide()})})},e.init=function(){k=d3.select("#compare-legend").append("div").classed("menu",!0),m=d3.select("#compare .chart"),k.on("mouseout",function(e){b.activeMenu||m.classed("active",!1).selectAll(".bezirke").classed("active",!1)}),y=k.selectAll("div").data(r).enter().append("div").classed("entry",!0).on("mouseenter",function(e){b.activeMenu||(k.selectAll(".entry").classed("hover",function(t){return t.key===e.key}),m.classed("active",!0).selectAll(".bezirke").classed("active",function(t){return e.key===t.key}).filter(".active").moveToFront())}),y.append("div").text("×").classed("close",!0),y.append("div").text(function(e){return e.mean}).classed("labell",!0),y.append("div").classed("labell",!0).text(function(e,t){return e.key});var t=m.selectAll("div").data(a).enter().append("div").each(function(e){return e}).attr("class","col col-xs-12 col-sm-4 col-lg-4").append("svg").attr("id",function(e){return e.key}).append("g").attr("transform","translate("+x.left+","+x.top+")");t.append("text").text(function(e){return z[e.key]}).attr("y",-10),g=t.append("g"),e.resize()},e.makeAxis=function(e){var t=e.append("g");t.append("g").attr("class","x axis").attr("transform","translate(0,"+o+")").call(f);var n=t.append("g").attr("class","y axis").call(p);n.selectAll("text").attr("x",-6),n.selectAll("g").filter(function(e){return e}).classed("minor",!0)},e}d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};